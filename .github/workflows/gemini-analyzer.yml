name: Revue de Code Critique (ESLint + Gemini)

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master
      - develop
  # Permet de lancer le workflow manuellement depuis l'interface GitHub
  workflow_dispatch:

jobs:
  code_quality_check:
    runs-on: ubuntu-latest
    
    # 1. D√©finition des variables dynamiques (user info)
    # Utilit√© : Ces variables injectent le nom et l'e-mail de l'utilisateur qui a d√©clench√© l'√©v√©nement.
    env:
      PUSHER_EMAIL: ${{ github.event.pusher.email || github.event.pull_request.user.email }}
      PUSHER_NAME: ${{ github.event.pusher.name || github.event.pull_request.user.login }}
      PREF_INTEREST: ${{ secrets.CI_PREF_INTEREST || 'la performance et la s√©curit√©' }}

    steps:
      - name: ‚¨áÔ∏è Checkout du code
        uses: actions/checkout@v4
        # Utilit√© : T√©l√©charge le code du d√©p√¥t sur la machine virtuelle de GitHub.

      - name: üõ†Ô∏è Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
        # Utilit√© : Configure l'environnement Python n√©cessaire.

      - name: üì• Installation des d√©pendances (Python)
        run: pip install -r requirements.txt
        # Utilit√© : Installe les biblioth√®ques Python n√©cessaires (google-genai, python-dotenv, etc.).

# --- D√âBUT DE LA NOUVELLE LOGIQUE CONDITIONNELLE (Correction de l'erreur CRITIQUE) ---

      - name: üîç V√©rifier la pr√©sence de package.json (pour Node/ESLint)
        id: check_package_json
        run: |
          if [ -f package.json ]; then
            # ::set-output est une commande sp√©ciale qui stocke une variable pour les √©tapes suivantes.
            echo "::set-output name=found_package_json::true"
            echo "::notice file=package.json::Fichier package.json trouv√©. Les √©tapes Node/ESLint seront ex√©cut√©es."
          else
            echo "::set-output name=found_package_json::false"
            echo "::notice file=package.json::Fichier package.json non trouv√©. Les √©tapes Node/ESLint seront saut√©es."
          fi
        # Utilit√© : Cette √©tape permet de rendre les √©tapes JavaScript/Node.js/ESLint facultatives
        # en v√©rifiant l'existence du fichier 'package.json'.

      - name: üì¶ Installation des d√©pendances (Node/ESLint)
        if: steps.check_package_json.outputs.found_package_json == 'true'
        run: npm install
        # Utilit√© : L'attribut 'if:' assure que cette √©tape ne s'ex√©cute QUE si 'found_package_json' est 'true'.
        # Cela emp√™che 'npm install' d'√©chouer si le projet est purement Python ou autre.

      - name: üî¨ Ex√©cution de l'Analyse Statique (ESLint)
        if: steps.check_package_json.outputs.found_package_json == 'true'
        run: |
          ./node_modules/.bin/eslint . --ext .js,.jsx,.ts,.tsx --max-warnings 0
        continue-on-error: false
        # Utilit√© : L'attribut 'if:' assure que ESLint ne s'ex√©cute que si les d√©pendances ont √©t√© install√©es.
        # L'option 'continue-on-error: false' force l'√©chec du job si ESLint trouve des erreurs non critiques.

# --- FIN DE LA LOGIQUE CONDITIONNELLE ---

      - name: üß† Ex√©cution de l'Analyse Critique par Gemini
        run: python gemini_code_analyzer.py
        env:
          # SECRET CRITIQUE (Cl√© API)
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # SECRETS SMTP (pour l'envoi d'e-mail)
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        # Utilit√© : Lance le script d'analyse Python. Cette √©tape est ind√©pendante des d√©pendances Node.js.